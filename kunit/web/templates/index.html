<!doctype html>
<html lang="ru" class="h-full">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>kunit — Конвертер единиц LS-DYNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-full bg-slate-50 text-slate-900">
    <div class="max-w-6xl mx-auto px-4 py-10 space-y-6">
      <header class="flex items-center justify-between flex-wrap gap-3 mb-2">
        <div>
          <p class="text-sm uppercase tracking-wide text-slate-500 font-semibold">LS-DYNA</p>
          <h1 class="text-3xl font-semibold leading-tight">kunit — конвертер единиц</h1>
          <p class="text-slate-600">Преобразуйте модели между системами единиц, сохраняя фиксированную ширину.</p>
        </div>
      </header>

      {% if error_msg %}
        <div class="rounded-lg border border-rose-200 bg-rose-50 text-rose-900 px-4 py-3">
          {{ error_msg }}
        </div>
      {% endif %}

      <form id="convert-form" method="post" action="/convert" enctype="multipart/form-data" class="space-y-6">
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-5 space-y-4">
            <div class="space-y-2">
              <label for="file_input" class="block text-sm font-medium text-slate-700">Файл (.k)</label>
              <input type="file" id="file_input" name="file_input" accept=".k,text/plain" class="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" />
              <p class="text-xs text-slate-500">Файл приоритетен, если вставка пустая.</p>
            </div>
            <div class="space-y-2">
              <label for="text_input" class="block text-sm font-medium text-slate-700">Или вставьте текст</label>
              <textarea id="text_input" name="text_input" placeholder="Вставьте содержимое .k..." class="w-full h-56 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-400 focus:border-sky-400 bg-slate-50/60 px-3 py-2 font-mono text-sm" ></textarea>
            </div>
            <input type="hidden" name="custom_transforms" value="{{ custom_transforms }}" />
          </div>

          <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-5 space-y-4">
            <div class="grid md:grid-cols-[1fr_auto_1fr] items-end gap-3">
              <div>
                <label class="block text-sm font-medium text-slate-700">Исходные единицы</label>
                {% set selected_src = selected_src or (units|first).key %}
                <select name="src" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400">
                  {% for u in units %}
                  <option value="{{ u.key }}" {% if selected_src == u.key %}selected{% endif %}>{{ u.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="text-center text-slate-500 pb-2">→</div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Целевые единицы</label>
                {% set selected_dst = selected_dst or (units|last).key %}
                <select name="dst" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400">
                  {% for u in units %}
                  <option value="{{ u.key }}" {% if selected_dst == u.key %}selected{% endif %}>{{ u.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div>
              <p class="block text-sm font-medium text-slate-700 mb-2">Модели</p>
              {% set selected_models = selected_models or default_models %}
              <div class="grid sm:grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-1">
                {% for m in models %}
                <label class="flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 bg-slate-50/80 hover:border-sky-300">
                  <input type="checkbox" name="models" value="{{ m }}" {% if not selected_models or m in selected_models %}checked{% endif %} class="h-4 w-4 text-sky-600 border-slate-300 rounded" />
                  <span class="text-sm text-slate-800">{{ m }}</span>
                </label>
                {% endfor %}
              </div>
            </div>

            <div class="space-y-2">
              <label for="out_name" class="block text-sm font-medium text-slate-700">Имя файла результата</label>
              <input type="text" id="out_name" name="out_name" value="{{ out_name or 'converted.k' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400" />
            </div>

            <div class="flex items-center gap-3 pt-2">
              <button type="submit" class="inline-flex items-center justify-center rounded-xl bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500">Конвертировать</button>
              <p class="text-xs text-slate-500">Состояние формы сохраняется локально.</p>
            </div>
          </div>
        </div>
      </form>

      <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-5 space-y-4">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <div>
            <p class="text-sm uppercase tracking-wide text-slate-500 font-semibold">Карты материалов</p>
            <h2 class="text-xl font-semibold leading-tight">Выбор из библиотеки (без загрузки)</h2>
            <p class="text-slate-600 text-sm">Материалы добавляет только разработчик в папку приложения; выберите нужные и экспортируйте их в одну систему единиц.</p>
          </div>
          <div class="text-sm text-slate-600">Всего доступно: {{ materials|length }}</div>
        </div>

        {% if materials_error %}
          <div class="rounded-lg border border-rose-200 bg-rose-50 text-rose-900 px-4 py-3">{{ materials_error }}</div>
        {% endif %}

        <form method="post" action="/materials/export" class="space-y-4">
          <div class="grid md:grid-cols-[2fr_1fr] gap-4">
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-72 overflow-y-auto pr-1">
              {% for m in materials %}
                <label class="flex items-start gap-3 rounded-xl border border-slate-200 px-3 py-2 bg-slate-50/80 hover:border-sky-300">
                  <input type="checkbox" name="materials" value="{{ m.material_id }}" class="mt-1 h-4 w-4 text-sky-600 border-slate-300 rounded" {% if m.material_id in (selected_materials or []) %}checked{% endif %} />
                  <span class="text-sm text-slate-800">
                    <span class="font-semibold block">{{ m.name }}</span>
                    <span class="text-xs text-slate-500">{{ m.model }} · {{ unit_labels.get(m.units, m.units) }}</span>
                    {% if m.comment %}
                      <span class="text-xs text-slate-600 block">{{ m.comment }}</span>
                    {% endif %}
                    {% if m.tags %}
                      <span class="text-xs text-slate-500 block">{{ ", ".join(m.tags) }}</span>
                    {% endif %}
                    {% if m.reference %}
                      <a href="{{ m.reference }}" target="_blank" rel="noreferrer" class="text-xs text-sky-600 hover:text-sky-700">Источник</a>
                    {% endif %}
                  </span>
                </label>
              {% endfor %}
            </div>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-slate-700">Экспортировать в единицы</label>
                {% set materials_dst = materials_dst or (units|first).key %}
                <select name="materials_dst" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400">
                  {% for u in units %}
                  <option value="{{ u.key }}" {% if materials_dst == u.key %}selected{% endif %}>{{ u.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">Имя файла для выгрузки</label>
                <input type="text" name="materials_out_name" value="{{ materials_out_name or 'materials.k' }}" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400" />
              </div>
              <div class="flex items-center gap-3">
                <button type="submit" class="inline-flex items-center justify-center rounded-xl bg-slate-800 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-600">Экспортировать</button>
                <p class="text-xs text-slate-500">Можно сразу копировать результат или скачать файл.</p>
              </div>
            </div>
          </div>

          {% if materials_export %}
            <div class="rounded-xl border border-slate-200 bg-slate-50/80 p-4 space-y-3">
              <div class="flex items-center justify-between gap-3 flex-wrap">
                <div>
                  <p class="text-sm font-semibold">Результат экспорта</p>
                  <p class="text-xs text-slate-500">Сконвертировано в {{ unit_labels.get(materials_dst, materials_dst) }}.</p>
                </div>
                <div class="flex items-center gap-2">
                  <button type="button" id="materials-copy" class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white/90 px-3 py-2 shadow-sm hover:border-sky-300 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500 text-sm" data-target="materials-output">Копировать</button>
                  <form method="post" action="/materials/download" class="flex items-center">
                    <input type="hidden" name="payload" value="{{ materials_export }}" />
                    <input type="hidden" name="materials_out_name" value="{{ materials_out_name or 'materials.k' }}" />
                    <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-sky-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-500">Скачать</button>
                  </form>
                </div>
              </div>
              <textarea id="materials-output" readonly class="w-full h-60 rounded-xl border border-slate-200 bg-white px-3 py-3 font-mono text-sm focus:ring-2 focus:ring-sky-400 focus:border-sky-400">{{ materials_export }}</textarea>
            </div>
          {% endif %}
        </form>
      </div>
    </div>

    <script>
      (function () {
        const STORAGE_KEY = 'kunit_form_state_v1';
        const form = document.getElementById('convert-form');
        const selSrc = form.querySelector('select[name="src"]');
        const selDst = form.querySelector('select[name="dst"]');
        const outName = document.getElementById('out_name');
        const txt = document.getElementById('text_input');
        const fileInput = document.getElementById('file_input');
        const materialsCopy = document.getElementById('materials-copy');

        function getSelectedModels() {
          return Array.from(form.querySelectorAll('input[name="models"]'))
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        }

        function setSelectedModels(values) {
          const set = new Set(values || []);
          const boxes = Array.from(form.querySelectorAll('input[name="models"]'));
          boxes.forEach(cb => { cb.checked = false; });
          boxes.forEach(cb => { if (set.has(cb.value)) cb.checked = true; });
        }

        function saveState() {
          const state = {
            src: selSrc?.value || null,
            dst: selDst?.value || null,
            out_name: outName?.value || null,
            text_input: txt?.value || '',
            models: getSelectedModels(),
          };
          try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
        }

        function restoreState() {
          let raw;
          try { raw = localStorage.getItem(STORAGE_KEY); } catch (e) {}
          if (!raw) return;
          let state;
          try { state = JSON.parse(raw); } catch (e) { return; }
          if (state && typeof state === 'object') {
            if (state.src && selSrc && Array.from(selSrc.options).some(o => o.value === state.src)) selSrc.value = state.src;
            if (state.dst && selDst && Array.from(selDst.options).some(o => o.value === state.dst)) selDst.value = state.dst;
            if (typeof state.out_name === 'string' && outName) outName.value = state.out_name;
            if (typeof state.text_input === 'string' && txt) txt.value = state.text_input;
            if (Array.isArray(state.models)) setSelectedModels(state.models);
          }
        }

        document.addEventListener('DOMContentLoaded', restoreState, { once: true });
        ['change', 'input'].forEach(ev => {
          form.addEventListener(ev, (e) => {
            if (e && e.target === fileInput) { saveState(); return; }
            saveState();
          });
        });
        form.addEventListener('submit', saveState);

        materialsCopy?.addEventListener('click', () => {
          const targetId = materialsCopy.getAttribute('data-target');
          const target = document.getElementById(targetId);
          if (!target) return;
          target.select();
          document.execCommand('copy');
        });
      })();
    </script>
  </body>
</html>
