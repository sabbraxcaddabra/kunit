<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Результат — kunit</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      pre { background: #fafafa; padding: 1rem; border: 1px solid #eee; overflow: auto; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .meta { margin-bottom: 1rem; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h1>Результат</h1>

    <div class="meta">
      <div>Единицы: <strong>{{ src }}</strong> → <strong>{{ dst }}</strong></div>
      <div>Модели: <strong>{{ ", ".join(models) }}</strong></div>
      <div>Изменённых строк: <strong>{{ preview.changed_lines }}</strong></div>
      <form method="post" action="/download">
        <input type="hidden" name="src" value="{{ src }}">
        <input type="hidden" name="dst" value="{{ dst }}">
        <input type="hidden" name="out_name" value="{{ out_name }}">
        {% for m in models %}
          <input type="hidden" name="models" value="{{ m }}">
        {% endfor %}
        <textarea name="payload" style="display:none;">{{ payload }}</textarea>
        <button type="submit">Скачать {{ out_name }}</button>
      </form>
      <p class="muted">Скачивание формирует файл заново из исходного текста.</p>
    </div>

    <div class="grid">
      <div>
        <h3>До</h3>
        <pre>{{ preview.before_snippet }}</pre>
      </div>
      <div>
        <h3>После (фрагмент)</h3>
        <pre>{{ preview.after_snippet }}</pre>
      </div>
    </div>

    <h3>Полный результат</h3>
    <p>
      <button id="copy-btn" type="button">Скопировать в буфер</button>
    </p>
    <textarea id="converted-output" readonly style="width:100%;height:320px;font-family:ui-monospace,monospace;">{{ converted_text }}</textarea>

    <p><a href="/">← Назад</a></p>
    <script>
      (function(){
        const btn = document.getElementById('copy-btn');
        const ta = document.getElementById('converted-output');
        function copyText(text){
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
          }
          // Fallback for older browsers
          ta.select();
          document.execCommand('copy');
          return Promise.resolve();
        }
        btn?.addEventListener('click', async () => {
          try {
            await copyText(ta.value);
            btn.textContent = 'Скопировано!';
            setTimeout(() => btn.textContent = 'Скопировать в буфер', 1500);
          } catch (e) {
            btn.textContent = 'Не удалось скопировать';
            setTimeout(() => btn.textContent = 'Скопировать в буфер', 2000);
          }
        });
      })();
    </script>
  </body>
  </html>
